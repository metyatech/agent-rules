## マルチプレイ・ネットワーク・レプリケーション

### サーバ権威

#### 基本原則

クライアントは状態を決定しない。`HasAuthority()` を厳密に確認し、サーバでのみゲーム状態を変更する。

#### クライアント入力の検証

クライアント入力・ネットワークデータは常に不信任で扱い、サーバ側で必ず検証/正規化する。過大な Payload は禁止。

### RPC

`UFUNCTION(Server/Client, Reliable/Unreliable)` を意図に応じて使い分ける。

| 属性               | 用途                                              |
| ------------------ | ------------------------------------------------- |
| Server, Reliable   | 重要なクライアント→サーバ通信（アクション実行等） |
| Server, Unreliable | 頻繁なクライアント→サーバ通信（入力等）           |
| Client, Reliable   | 重要なサーバ→クライアント通信（状態変更通知等）   |
| Client, Unreliable | 頻繁なサーバ→クライアント通信（位置更新等）       |

### レプリケーション

#### 基本実装

`UPROPERTY(Replicated/ReplicatedUsing)` と `GetLifetimeReplicatedProps` を正しく実装する。

#### 最適化

以下を活用してネットワーク帯域を節約する：

- `COND_*` 条件
- `bNetUseOwnerRelevancy`
- `NetCullDistanceSquared`

#### 配列/大量データの同期

頻繁に変化する配列は `FFastArraySerializer` を優先し、大容量の TArray の逐次レプリケーションを避けて差分化する。

#### Dormancy

Dormancy を活用し、状態変更後は `ForceNetUpdate` 等を必要に応じて呼んで反映を促進する。

#### NetSerialize

ネットワーク/保存対象の構造体は必要に応じて `NetSerialize` を実装し、バージョン管理を付与する。

### 予測と再同期

レイテンシ影響が大きい処理はクライアント予測＋サーバ再同期を採用する。位置ではなく入力を同期し、補正は小刻みに抑制する。

### シームレストラベル

シームレストラベルを前提とし、UWorld やレベル固有の参照を跨いで保持しない。再取得可能なハンドルや ID のみを保持する。

### 乱数

ゲームロジックの乱数は `FRandomStream` を使用し、シードをレプリケート/セーブする。`FMath::Rand` は使用禁止。

### HTTP/オンライン

UE の HTTP/OSS を使用し、非同期処理・リトライ（指数バックオフ＋ジッタ）・タイムアウトを実装する。ゲームスレッドで待機禁止。
